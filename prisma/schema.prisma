// ─── Prisma Client ────────────────────────────────────────────────────────────

generator client {
  provider = "prisma-client-js"
}

// ─── Data Source ──────────────────────────────────────────────────────────────

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ────────────────────────────────────────────────────────────────────

enum Role {
  ADMIN
  INITIATOR
  APPROVER
  USER
}

enum DocumentStatus {
  DRAFT
  IN_APPROVAL
  APPROVED
  REJECTED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

// ─── Models ───────────────────────────────────────────────────────────────────

model User {
  id         String   @id @default(uuid())
  name       String
  email      String   @unique
  password   String
  role       Role     @default(USER)
  department String?
  createdAt  DateTime @default(now())

  // Relations
  templates        Template[]   @relation("TemplateCreator")
  initiatedDocs    Document[]   @relation("DocumentInitiator")
  assignedDocs     Document[]   @relation("DocumentApprover")
  approvals        Approval[]
  notifications    Notification[]
  auditLogs        AuditLog[]
  comments         Comment[]
  files            File[]
}

model Template {
  id          String   @id @default(uuid())
  name        String
  description String?
  content     String?  // Template content with variables like {{fieldName}}
  fields      Json?    // Array of field definitions: [{ key, label, type, required }]
  createdAt   DateTime @default(now())

  // Relations
  createdBy      User            @relation("TemplateCreator", fields: [createdById], references: [id])
  createdById    String
  documents      Document[]
  approvalRoute  ApprovalRoute?
}

model Document {
  id               String         @id @default(uuid())
  number           String         @unique
  title            String
  status           DocumentStatus @default(DRAFT)
  fieldValues      Json?          // Filled field values: { fieldKey: value }
  currentStepNumber Int?          // Current approval step number (1, 2, 3, etc.)
  createdAt        DateTime       @default(now())

  // Relations
  template          Template   @relation(fields: [templateId], references: [id])
  templateId        String
  initiator         User       @relation("DocumentInitiator", fields: [initiatorId], references: [id])
  initiatorId       String
  currentApprover   User?      @relation("DocumentApprover", fields: [currentApproverId], references: [id])
  currentApproverId String?
  approvals         Approval[]
  auditLogs         AuditLog[]
  comments          Comment[]
  files             File[]
}

model Approval {
  id         String         @id @default(uuid())
  status     ApprovalStatus @default(PENDING)
  comment    String?
  decidedAt  DateTime?
  stepNumber Int?           // Which step this approval belongs to (1, 2, 3, etc.)

  // Relations
  document   Document @relation(fields: [documentId], references: [id])
  documentId String
  approver   User     @relation(fields: [approverId], references: [id])
  approverId String

  @@unique([documentId, approverId, stepNumber])
}

model Notification {
  id        String   @id @default(uuid())
  type      String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user   User   @relation(fields: [userId], references: [id])
  userId String
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String
  metadata   Json?
  createdAt  DateTime @default(now())

  // Relations
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId String
  user       User     @relation(fields: [userId], references: [id])
  userId     String
}

model Comment {
  id         String   @id @default(uuid())
  text       String
  createdAt  DateTime @default(now())

  // Relations
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId String
  user       User     @relation(fields: [userId], references: [id])
  userId     String
}

model File {
  id         String   @id @default(uuid())
  name       String
  path       String
  size       Int
  mimeType   String
  createdAt  DateTime @default(now())

  // Relations
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId String
  user       User     @relation(fields: [userId], references: [id])
  userId     String
}

model ApprovalRoute {
  id          String   @id @default(uuid())
  name        String   // e.g. "Standard Contract Approval"
  description String?
  createdAt   DateTime @default(now())

  // Relations
  template   Template            @relation(fields: [templateId], references: [id], onDelete: Cascade)
  templateId String              @unique
  steps      ApprovalRouteStep[]
}

model ApprovalRouteStep {
  id          String   @id @default(uuid())
  stepNumber  Int      // 1, 2, 3, etc. (order of steps)
  name        String   // e.g. "Department Head Approval"
  description String?
  approverIds Json     // Array of user IDs who can approve at this step: ["userId1", "userId2"]
  requireAll  Boolean  @default(false) // If true, ALL approvers must approve; if false, ANY approver can approve

  // Relations
  route   ApprovalRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)
  routeId String

  @@unique([routeId, stepNumber])
}
